name: VPS + Puppeteer

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup tmate + Puppeteer
        run: |
          # Download tmate
          curl -fsSL https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          chmod +x tmate-2.4.0-static-linux-amd64/tmate

          # Create remote-link.txt
          echo "=== VPS Link - $(date) ===" > remote-link.txt
          echo "" >> remote-link.txt

          echo "Creating VPS..."
          ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate new-session -d "bash"
          sleep 8

          # Get tmate links
          SSH_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate display -p '#{tmate_ssh}')
          WEB_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate display -p '#{tmate_web}')

          # Write links to file
          echo "SSH: $SSH_LINK" >> remote-link.txt
          echo "Web: $WEB_LINK" >> remote-link.txt
          echo "---" >> remote-link.txt

          echo "âœ… VPS ready!"
          echo "SSH: $SSH_LINK"
          echo "Web: $WEB_LINK"

          # Install dependencies for Chrome / Puppeteer
          sudo apt-get update
          sudo apt-get install -y wget unzip fonts-liberation libx11-xcb1 libxcomposite1 \
            libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 libxrandr2 libatk1.0-0 \
            libatk-bridge2.0-0 libcups2 libdbus-1-3 libdrm2 libxss1 libasound2 libgbm1 xdg-utils

          # Install Google Chrome
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

          # Setup Node.js
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # Install Puppeteer
          npm install puppeteer

          echo "âœ… Puppeteer + Chrome installed!"

      - name: Commit tmate link
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add remote-link.txt
          git commit -m "VPS Puppeteer link - $(date)" || exit 0
          git push https://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@github.com/${{ github.repository }} HEAD:main || exit 0

      - name: Keep alive
        run: |
          echo "ðŸ”¥ VPS with Puppeteer ready!"
          echo "ðŸ“‹ Check remote-link.txt for SSH/Web link"
          # Keep session alive for 25 minutes
          sleep 1500
