name: VPS 15x tmate

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup multiple tmate sessions
        run: |
          # Tạo file remote-link.txt
          echo "=== VPS Links Generated at $(date) ===" > remote-link.txt
          echo "" >> remote-link.txt
          
          # Download tmate
          curl -fsSL https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          chmod +x tmate-2.4.0-static-linux-amd64/tmate
          
          # Tạo 15 tmate sessions
          for i in {1..15}; do
            echo "Creating VPS $i..."
            
            # Tạo session với socket riêng
            ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i new-session -d "bash"
            
            # Đợi session khởi tạo
            sleep 5
            
            # Lấy thông tin kết nối
            SSH_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i display -p '#{tmate_ssh}')
            WEB_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate-$i display -p '#{tmate_web}')
            
            # Ghi vào file
            echo "VPS $i:" >> remote-link.txt
            echo "SSH: $SSH_LINK" >> remote-link.txt
            echo "Web: $WEB_LINK" >> remote-link.txt
            echo "---" >> remote-link.txt
            echo "" >> remote-link.txt
            
            echo "VPS $i created successfully"
          done

      - name: Commit and push links
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add remote-link.txt
          git commit -m "Update VPS links - $(date)"
          git push https://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@github.com/${{ github.repository }} HEAD:main

      - name: Keep session alive
        run: |
          echo "All VPS created! Check remote-link.txt for connection details"
          # Giữ workflow chạy trong 25 phút (timeout sẽ tự dừng)
          sleep 1500
