name: VPS + Puppeteer Optimized
on:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip curl git ca-certificates openssh-server jq

      - name: Install Chrome
        run: |
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome.deb || sudo apt-get install -f -y
          google-chrome --version

      - name: Install Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node --version
          npm --version

      - name: Setup SSH and Ngrok
        run: |
          sudo service ssh start
          echo "runner:123456" | sudo chpasswd
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          nohup ngrok tcp 22 --region=ap > ngrok.log 2>&1 &
          sleep 8
          TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          HOST=$(echo $TUNNEL_URL | cut -d':' -f2 | sed 's#//##')
          PORT=$(echo $TUNNEL_URL | cut -d':' -f3)
          echo "========================================"
          echo "SSH command:"
          echo "ssh runner@$HOST -p $PORT"
          echo "Password: 123456"
          echo "========================================"
          sleep 3600
