name: VPS + Puppeteer Maximum Resource Usage
on:
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    steps:
      - uses: actions/checkout@v4
      
      - name: System Optimization
        run: |
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w vm.vfs_cache_pressure=10
          sudo sysctl -w vm.overcommit_memory=1
          sudo sysctl -w vm.max_map_count=2147483647
          sudo sysctl -w net.core.rmem_max=268435456
          sudo sysctl -w net.core.wmem_max=268435456
          sudo sysctl -w net.ipv4.tcp_rmem="8192 131072 268435456"
          sudo sysctl -w net.ipv4.tcp_wmem="8192 131072 268435456"
          sudo apt-get clean
          sudo apt-get autoremove -y
          
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            wget unzip curl git ca-certificates gnupg lsb-release \
            fonts-liberation libx11-xcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxi6 libxtst6 libnss3 libxrandr2 libatk1.0-0 \
            libatk-bridge2.0-0 libcups2 libdbus-1-3 libdrm2 libxss1 \
            libgbm1 xdg-utils libasound2t64 libxshmfence1 htop
            
      - name: Install Chrome
        run: |
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome.deb || sudo apt-get install -f -y
          google-chrome --version
          
      - name: Install Node.js and Python
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs python3 python3-pip python3-dev python3-venv
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 2
          npm config set fetch-retry-mintimeout 
          
      - name: Install Puppeteer Dependencies
        run: |
          npm install --silent puppeteer-real-browser hpack
          git clone --depth 1 https://github.com/depchaiaiyeu/dos-bot
          cd dos-bot
          if [ -f "package.json" ]; then
            npm install --silent --production
          fi
          
      - name: Configure Maximum Resource Usage
        run: |
          TOTAL_RAM_MB=$(free -m | awk '/^Mem:/{print $2}')
          TOTAL_CORES=$(nproc)
          MAX_OLD_SPACE=$((TOTAL_RAM_MB * 95 / 100))
          MAX_THREADS=$((TOTAL_CORES * 8))
          
          echo "export NODE_OPTIONS=\"--max-old-space-size=${MAX_OLD_SPACE} --max-semi-space-size=512\"" >> ~/.bashrc
          echo "export UV_THREADPOOL_SIZE=${MAX_THREADS}" >> ~/.bashrc
          source ~/.bashrc
          
          echo "NODE_OPTIONS=--max-old-space-size=${MAX_OLD_SPACE} --max-semi-space-size=512" | sudo tee -a /etc/environment
          echo "UV_THREADPOOL_SIZE=${MAX_THREADS}" | sudo tee -a /etc/environment
          
          echo "VPS will use 95% of available resources:"
          echo "Total RAM: ${TOTAL_RAM_MB} MB"
          echo "Node.js RAM limit: ${MAX_OLD_SPACE} MB" 
          echo "CPU Cores: ${TOTAL_CORES}"
          echo "Thread pool: ${MAX_THREADS}"
          
      - name: Setup Performance Monitor
        run: |
          cat > monitor.sh << 'EOF'
          #!/bin/bash
          while true; do
            echo "=== $(date) ==="
            echo "Memory Usage:"
            free -h
            echo "CPU Usage:"
            top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1
            echo "Active Node Processes:"
            ps aux | grep node | grep -v grep | wc -l
            echo "Chrome Processes:"
            ps aux | grep chrome | grep -v grep | wc -l
            echo "===================="
            sleep 30
          done
          EOF
          chmod +x monitor.sh
          
      - name: Setup tmate
        run: |
          TOTAL_RAM_MB=$(free -m | awk '/^Mem:/{print $2}')
          TOTAL_CORES=$(nproc)
          MAX_OLD_SPACE=$((TOTAL_RAM_MB * 95 / 100))
          MAX_THREADS=$((TOTAL_CORES * 8))
          
          export NODE_OPTIONS="--max-old-space-size=${MAX_OLD_SPACE} --max-semi-space-size=512"
          export UV_THREADPOOL_SIZE=${MAX_THREADS}
          
          curl -fsSL https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz | tar -xJ
          chmod +x tmate-2.4.0-static-linux-amd64/tmate
          ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate new-session -d "cd dos-bot && export NODE_OPTIONS='--max-old-space-size=${MAX_OLD_SPACE} --max-semi-space-size=512' && export UV_THREADPOOL_SIZE=${MAX_THREADS} && bash"
          sleep 10
          SSH_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate display -p '#{tmate_ssh}')
          WEB_LINK=$(./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate display -p '#{tmate_web}')
          echo "========================================"
          echo "VPS READY - 95% Resource Usage Enabled"
          echo "========================================"
          echo "SSH Access: $SSH_LINK"
          echo "Web Access: $WEB_LINK"
          echo "========================================"
          echo "System automatically configured for maximum performance:"
          echo "CPU Cores: ${TOTAL_CORES}"
          echo "Total RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "Node.js RAM: ${MAX_OLD_SPACE} MB (95%)"
          echo "Thread Pool: ${MAX_THREADS}"
          echo "Chrome: $(google-chrome --version)"
          echo "Node.js: $(node --version)"
          echo "========================================"
          
      - name: Keep alive
        run: |
          nohup ./monitor.sh > monitor.log 2>&1 &
          start_time=$(date +%s)
          target_duration=1800
          
          echo "VPS running at 95% capacity for 30 minutes"
          echo "Started at: $(date)"
          
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            remaining=$((target_duration - elapsed))
            
            if [ $remaining -le 0 ]; then
              echo "30 minutes completed! Shutting down gracefully..."
              break
            fi
            
            if [ $((elapsed % 300)) -eq 0 ]; then
              echo "Running time: $((elapsed/60)) minutes, Remaining: $((remaining/60)) minutes"
              
              if ! pgrep -f "tmate" > /dev/null; then
                echo "tmate process died, restarting..."
                TOTAL_RAM_MB=$(free -m | awk '/^Mem:/{print $2}')
                TOTAL_CORES=$(nproc)
                MAX_OLD_SPACE=$((TOTAL_RAM_MB * 95 / 100))
                MAX_THREADS=$((TOTAL_CORES * 8))
                ./tmate-2.4.0-static-linux-amd64/tmate -S /tmp/tmate new-session -d "cd dos-bot && export NODE_OPTIONS='--max-old-space-size=${MAX_OLD_SPACE} --max-semi-space-size=512' && export UV_THREADPOOL_SIZE=${MAX_THREADS} && bash"
              fi
              
              if [ $((elapsed % 600)) -eq 0 ]; then
                echo "Performing memory cleanup..."
                sync && echo 1 | sudo tee /proc/sys/vm/drop_caches > /dev/null
              fi
            fi
            
            sleep 30
          done
          
      - name: Final Cleanup
        if: always()
        run: |
          echo "Session completed successfully!"
          echo "Final system status:"
          free -h
          df -h
          uptime
